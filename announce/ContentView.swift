import SwiftUI
import AVFoundation
import Combine

struct ScheduleItem: Identifiable {
    let id = UUID()
    let date: Date
    let displayName: String    // 画面表示名
    let resourceName: String   // バンドル内 wav 名（拡張子なし）
}

final class AudioPlayerManager: NSObject, ObservableObject, AVAudioPlayerDelegate {
    @Published var isPlaying = false
    @Published var currentTrackName: String = ""
    private var player: AVAudioPlayer?
    
    func play(resourceName: String, isMuted: Bool) {
        guard let url = Bundle.main.url(forResource: resourceName, withExtension: "wav") ??
                        Bundle.main.url(forResource: resourceName, withExtension: "mp3") else {
            print("❌ 音声ファイル未発見: \(resourceName)")
            return
        }
        do {
            player = try AVAudioPlayer(contentsOf: url)
            player?.delegate = self
            player?.volume = isMuted ? 0.0 : 1.0
            player?.prepareToPlay()
            player?.play()
            isPlaying = true
            currentTrackName = resourceName
            print("✅ 再生開始: \(resourceName) (\(url.lastPathComponent))")
        } catch {
            print("❌ 再生エラー: \(error)")
        }
    }
    
    func stop() {
        player?.stop()
        isPlaying = false
        currentTrackName = ""
    }
    
    func setMuted(_ muted: Bool) {
        player?.volume = muted ? 0.0 : 1.0
    }
    
    func audioPlayerDidFinishPlaying(_ player: AVAudioPlayer, successfully flag: Bool) {
        print("✅ 再生完了: \(flag ? "成功" : "失敗")")
        isPlaying = false
        currentTrackName = ""
    }
}

enum DemoMode {
    case demo1
    case demo2
    case demo3
}

struct ContentView: View {
    @State private var schedule: [ScheduleItem] = []
    @State private var currentTime = Date()
    @State private var countdown = "--"
    @State private var nextDisplayName = "なし"
    @State private var isMuted = false
    @State private var isRunning = false
    @State private var demoMode: DemoMode = .demo1
    @StateObject private var audioManager = AudioPlayerManager()
    
    private let timer = Timer.publish(every: 1, on: .main, in: .common).autoconnect()
    
    var body: some View {
        NavigationView {
            ScrollView {
                VStack(spacing: 20) {
                    // 変更後：明示的に「時:分:秒」表示
                    Text(currentTime.formatted(
                        .dateTime.hour().minute().second()
                    ))
                    .font(.system(size: 32, weight: .bold, design: .monospaced))
                    
                    // カウントダウン + 次の放送名
                    VStack(spacing: 8) {
                        Text("次再生まで: \(countdown)")
                            .font(.system(size: 22, weight: .bold))
                            .foregroundColor(.orange)
                        Text("📢 \(nextDisplayName)")
                            .font(.title2.bold())
                            .foregroundColor(.blue)
                    }
                    .padding()
                    .background(Color.blue.opacity(0.1))
                    .cornerRadius(15)
                    
                    // 再生／停止ボタン（ミュートの直前に追加）
                    Button {
                        toggleSchedule()
                    } label: {
                        HStack {
                            Image(systemName: isRunning ? "stop.circle.fill" : "play.circle.fill")
                                .font(.title)
                            Text(isRunning ? "再生中（停止する）" : "停止中（再生する）")
                                .font(.headline.bold())
                        }
                    }
                    .buttonStyle(.borderedProminent)
                    .tint(isRunning ? .red : .green)
                    
                    // ミュート
                    HStack {
                        Image(systemName: isMuted ? "speaker.slash.fill" : "speaker.wave.3.fill")
                            .font(.title2)
                            .foregroundColor(isMuted ? .red : .green)
                        Text(isMuted ? "ミュート中" : "音声ON")
                            .font(.headline.bold())
                            .foregroundColor(isMuted ? .red : .green)
                        Spacer()
                        Toggle("", isOn: $isMuted)
                            .toggleStyle(SwitchToggleStyle(tint: .blue))
                            .onChange(of: isMuted) { _, _ in
                                audioManager.setMuted(isMuted)
                            }
                    }
                    .padding()
                    .background(Color.gray.opacity(0.1))
                    .cornerRadius(12)
                    
                    // ミュートの下あたりに追加する例
                    VStack(spacing: 12) {

                        // 1段目：デモ1〜3
                        HStack {
                            Button("🗓️ 1") {
                                demoMode = .demo1
                                schedule = demoSchedule1()
                            }
                            Button("🗓️ 2") {
                                demoMode = .demo2
                                schedule = demoSchedule2()
                            }
                            Button("🗓️ 3") {
                                demoMode = .demo3
                                schedule = demoSchedule3()
                            }
                        }

//                        // 2段目：再生／停止
//                        Button(isRunning ? "⏹️ 停止する（再生中）": "▶️ 再生する（停止中）" ) {
//                            toggleSchedule()
//                        }
//                        .buttonStyle(.borderedProminent)
                    }
                    .padding()
                    
                    // 現在のデモ種別
                    Divider()
                        .padding(.vertical, 4)
                    HStack {
                        Text({
                            switch demoMode {
                            case .demo1:
                                return "デモ1（領域1・5：1回分）"
                            case .demo2:
                                return "デモ2（領域1・5）"
                            case .demo3:
                                return "デモ3（領域2・3・4）"
                            }
                        }())
                        .font(.subheadline)
                        .foregroundColor(.secondary)

                        Spacer()
                    }
                    .padding(.horizontal)
                    
                    // デモ種別表示のすぐ下あたりに追加（任意）
                    Divider()
                        .padding(.vertical, 4)
//                    Text("スケジュール一覧")
//                        .font(.subheadline.weight(.semibold))
//                        .foregroundColor(.secondary)
//                        .frame(maxWidth: .infinity, alignment: .leading)
//                        .padding(.horizontal)

                    // 下半分にスケジュールを縦スクロール表示
                    VStack(alignment: .leading, spacing: 8) {
                        Text("📋 全スケジュール (\(schedule.count)件)")
                            .font(.headline.bold())
                            .padding(.horizontal)
                            .padding(.top, 4)
                        
                        LazyVStack(spacing: 0) {          // ← 下側ブロックを LazyVStack で一覧化
                            ForEach(schedule) { item in
                                HStack(spacing: 12) {
                                    // 時刻
                                    Text(item.date, style: .time)
                                        .font(.system(.body, design: .monospaced))
                                        .foregroundColor(nextItemIs(item) ? .orange : .primary)
                                        .frame(width: 80, alignment: .leading)
                                    
                                    // ファイル名情報
                                    VStack(alignment: .leading, spacing: 2) {
                                        Text(item.displayName)              // 画面表示名
                                            .font(.body)
                                            .foregroundColor(nextItemIs(item) ? .orange : .primary)
                                        Text(item.resourceName + ".wav")    // 実際のファイル名
                                            .font(.caption)
                                            .foregroundColor(.secondary)
                                    }
                                    Spacer()
                                }
                                .padding(.vertical, 6)
                                .padding(.horizontal)
                                .background(nextItemIs(item) ? Color.orange.opacity(0.1) : Color.clear)
                            }
                        }
                    }
                    .frame(maxWidth: .infinity, alignment: .leading)
                    .background(Color.secondary.opacity(0.05))
                    .cornerRadius(12)
                }
                .frame(maxWidth: .infinity)   // ★追加
                .padding()
            }
            .navigationTitle("announce")
//            .toolbar {
//                ToolbarItemGroup(placement: .bottomBar) {
//                    Button("🧪 デモ1") {
//                        demoMode = .demo1
//                        schedule = demoSchedule1()
//                    }
//                    Button("🧪 デモ2") {
//                        demoMode = .demo2
//                        schedule = demoSchedule2()
//                    }
//                    Button("🧪 デモ3") {
//                        demoMode = .demo3
//                        schedule = demoSchedule3()
//                    }
//                    Button(isRunning ? "⏹️ 停止" : "▶️ 開始") {
//                        toggleSchedule()
//                    }
//                }
//            }
            .onReceive(timer) { _ in
                currentTime = Date()
                if isRunning { updateSchedule() }
            }
            .onAppear {
                setupAudio()
                schedule = demoSchedule1()
            }
        }
    }
    
    // 次に再生されるアイテムかどうか
    private func nextItemIs(_ item: ScheduleItem) -> Bool {
        let futureItems = schedule.filter { $0.date > currentTime }
        guard let next = futureItems.min(by: { $0.date < $1.date }) else { return false }
        return abs(item.date.timeIntervalSince(next.date)) < 2
    }
    
    // 1秒ごと更新
    private func updateSchedule() {
        let futureItems = schedule.filter { $0.date > currentTime }
        guard let nextItem = futureItems.min(by: { $0.date < $1.date }) else {
            countdown = "--"
            nextDisplayName = "なし"
            return
        }
        
        let diff = nextItem.date.timeIntervalSince(currentTime)
        if diff <= 1 {
            playAudio(nextItem)
        } else {
            let minutes = Int(diff) / 60
            let seconds = Int(diff) % 60
            countdown = "\(minutes)m \(seconds)s"
            nextDisplayName = nextItem.displayName
        }
    }
    
    private func toggleSchedule() {
        isRunning.toggle()
        if !isRunning {
            audioManager.stop()
            nextDisplayName = "なし"
            countdown = "--"
        }
    }
    
    private func setupAudio() {
        do {
            try AVAudioSession.sharedInstance().setCategory(.playback, mode: .default)
            try AVAudioSession.sharedInstance().setActive(true)
        } catch {
            print("オーディオ設定エラー: \(error)")
        }
    }
    
    // デモ1: 11本シナリオ
    private func demoSchedule1() -> [ScheduleItem] {
        let now = Date()
        let t1  = Calendar.current.date(byAdding: .second, value: 5, to: now) ?? now
        let t2  = Calendar.current.date(byAdding: .second, value: 10, to: now) ?? now
        let t3  = Calendar.current.date(byAdding: .second, value: 130, to: now) ?? now
        let t4  = Calendar.current.date(byAdding: .second, value: 370, to: now) ?? now
        let t5  = Calendar.current.date(byAdding: .second, value: 430, to: now) ?? now
        let t6  = Calendar.current.date(byAdding: .second, value: 430, to: now) ?? now
        let t7  = Calendar.current.date(byAdding: .second, value: 490, to: now) ?? now
        let t8  = Calendar.current.date(byAdding: .second, value: 820, to: now) ?? now
        let t9  = Calendar.current.date(byAdding: .second, value: 610, to: now) ?? now
        let t10 = Calendar.current.date(byAdding: .second, value: 670, to: now) ?? now
        let t11 = Calendar.current.date(byAdding: .second, value: 730, to: now) ?? now
        
        return [
            ScheduleItem(date: t1,  displayName: "入室",                 resourceName: "01 移動開始"),
            ScheduleItem(date: t2,  displayName: "閲覧",                 resourceName: "02 課題読む"),
            ScheduleItem(date: t3,  displayName: "開始",                 resourceName: "03 課題開始"),
            ScheduleItem(date: t4,  displayName: "終了1分前",            resourceName: "04 課題終了一分前"),
            ScheduleItem(date: t5,  displayName: "終了・退室",           resourceName: "05 課題終了・移動開始"),
            ScheduleItem(date: t6,  displayName: "終了",                 resourceName: "06 課題終了"),
            ScheduleItem(date: t7,  displayName: "開始2分前",            resourceName: "17 開始2分前"),
            ScheduleItem(date: t8,  displayName: "開始1分前",            resourceName: "18 開始1分前"),
            ScheduleItem(date: t9,  displayName: "休憩",                 resourceName: "19 休憩に入る"),
            ScheduleItem(date: t10, displayName: "テストラン開始1分前",  resourceName: "26 テストラン開始1分前"),
            ScheduleItem(date: t11, displayName: "放送終了",             resourceName: "20 放送終了のアナウンス")
        ].sorted { $0.date < $1.date }
    }
    
    // デモ2: 時刻＋ファイル名テーブル
    private func demoSchedule2() -> [ScheduleItem] {
        let calendar = Calendar.current
        let now = Date()
        let comps = calendar.dateComponents([.year, .month, .day], from: now)
        func makeTime(_ h: Int, _ m: Int, _ s: Int = 0) -> Date {
            var c = comps
            c.hour = h
            c.minute = m
            c.second = s
            return calendar.date(from: c) ?? now
        }
        
        
        let rows: [(Int, Int, Int, String, String)] = [
            (7, 30,  0, "01 移動開始",              "01 移動開始"),
            (7, 30, 30, "02 課題読む",              "02 課題読む"),
            (7, 31,  0, "03 課題開始",              "03 課題開始"),
            (7, 31, 30, "04 課題終了一分前",        "04 課題終了一分前"),
            (7, 32,  0, "05 課題終了・移動開始",    "05 課題終了・移動開始"),
            (7, 32, 30, "06 課題終了",              "06 課題終了"),

            (7, 40,  0, "01 移動開始",              "01 移動開始"),
            (7, 40, 30, "02 課題読む",              "02 課題読む"),
            (7, 41,  0, "03 課題開始",              "03 課題開始"),
            (7, 41, 30, "04 課題終了一分前",        "04 課題終了一分前"),
            (7, 42,  0, "05 課題終了・移動開始",    "05 課題終了・移動開始"),
            (7, 42, 30, "06 課題終了",              "06 課題終了"),

            (7, 50,  0, "01 移動開始",              "01 移動開始"),
            (7, 50, 30, "02 課題読む",              "02 課題読む"),
            (7, 51,  0, "03 課題開始",              "03 課題開始"),
            (7, 51, 30, "04 課題終了一分前",        "04 課題終了一分前"),
            (7, 52,  0, "05 課題終了・移動開始",    "05 課題終了・移動開始"),
            (7, 52, 30, "06 課題終了",              "06 課題終了"),

            (8,  0,  0, "01 移動開始",              "01 移動開始"),
            (8,  0, 30, "02 課題読む",              "02 課題読む"),
            (8,  1,  0, "03 課題開始",              "03 課題開始"),
            (8,  1, 30, "04 課題終了一分前",        "04 課題終了一分前"),
            (8,  2,  0, "05 課題終了・移動開始",    "05 課題終了・移動開始"),
            (8,  2, 30, "06 課題終了",              "06 課題終了"),

            (8, 20,  0, "01 移動開始",              "01 移動開始"),
            (8, 20, 30, "02 課題読む",              "02 課題読む"),
            (8, 21,  0, "03 課題開始",              "03 課題開始"),
            (8, 21, 30, "04 課題終了一分前",        "04 課題終了一分前"),
            (8, 22,  0, "05 課題終了・移動開始",    "05 課題終了・移動開始"),
            (8, 22, 30, "06 課題終了",              "06 課題終了"),

            (9,  9,  0, "26 テストラン開始1分前",   "26 テストラン開始1分前"),
            (9, 10,  0, "01 移動開始",              "01 移動開始"),
            (9, 11,  0, "02 課題読む",              "02 課題読む"),
            (9, 13,  0, "03 課題開始",              "03 課題開始"),
            (9, 17,  0, "04 課題終了一分前",        "04 課題終了一分前"),
            (9, 18,  0, "06 課題終了",              "06 課題終了"),

            (9, 28,  0, "17 開始2分前",             "17 開始2分前"),
            (9, 29,  0, "18 開始1分前",             "18 開始1分前"),
            (9, 30,  0, "01 移動開始",              "01 移動開始"),
            (9, 31,  0, "02 課題読む",              "02 課題読む"),
            (9, 33,  0, "03 課題開始",              "03 課題開始"),
            (9, 37,  0, "04 課題終了一分前",        "04 課題終了一分前"),
            (9, 38,  0, "05 課題終了・移動開始",    "05 課題終了・移動開始"),

            (9, 40,  0, "01 移動開始",              "01 移動開始"),
            (9, 41,  0, "02 課題読む",              "02 課題読む"),
            (9, 43,  0, "03 課題開始",              "03 課題開始"),
            (9, 47,  0, "04 課題終了一分前",        "04 課題終了一分前"),
            (9, 48,  0, "05 課題終了・移動開始",    "05 課題終了・移動開始"),

            (9, 50,  0, "01 移動開始",              "01 移動開始"),
            (9, 51,  0, "02 課題読む",              "02 課題読む"),
            (9, 53,  0, "03 課題開始",              "03 課題開始"),
            (9, 57,  0, "04 課題終了一分前",        "04 課題終了一分前"),
            (9, 58,  0, "05 課題終了・移動開始",    "05 課題終了・移動開始"),

            (10,  0,  0, "01 移動開始",             "01 移動開始"),
            (10,  1,  0, "02 課題読む",             "02 課題読む"),
            (10,  3,  0, "03 課題開始",             "03 課題開始"),
            (10,  7,  0, "04 課題終了一分前",       "04 課題終了一分前"),
            (10,  8,  0, "05 課題終了・移動開始",   "05 課題終了・移動開始"),

            (10, 10,  0, "01 移動開始",             "01 移動開始"),
            (10, 11,  0, "02 課題読む",             "02 課題読む"),
            (10, 13,  0, "03 課題開始",             "03 課題開始"),
            (10, 17,  0, "04 課題終了一分前",       "04 課題終了一分前"),
            (10, 18,  0, "05 課題終了・移動開始",   "05 課題終了・移動開始"),

            (10, 20,  0, "01 移動開始",             "01 移動開始"),
            (10, 21,  0, "02 課題読む",             "02 課題読む"),
            (10, 23,  0, "03 課題開始",             "03 課題開始"),
            (10, 27,  0, "04 課題終了一分前",       "04 課題終了一分前"),
            (10, 28,  0, "05 課題終了・移動開始",   "05 課題終了・移動開始"),

            (10, 30,  0, "01 移動開始",             "01 移動開始"),
            (10, 31,  0, "02 課題読む",             "02 課題読む"),
            (10, 33,  0, "03 課題開始",             "03 課題開始"),
            (10, 37,  0, "04 課題終了一分前",       "04 課題終了一分前"),
            (10, 38,  0, "05 課題終了・移動開始",   "05 課題終了・移動開始"),
            (10, 38, 15, "19 休憩に入る",           "19 休憩に入る"),

            (10, 48,  0, "17 開始2分前",            "17 開始2分前"),
            (10, 49,  0, "18 開始1分前",            "18 開始1分前"),
            (10, 50,  0, "01 移動開始",             "01 移動開始"),
            (10, 51,  0, "02 課題読む",             "02 課題読む"),
            (10, 53,  0, "03 課題開始",             "03 課題開始"),
            (10, 57,  0, "04 課題終了一分前",       "04 課題終了一分前"),
            (10, 58,  0, "05 課題終了・移動開始",   "05 課題終了・移動開始"),

            (11,  0,  0, "01 移動開始",             "01 移動開始"),
            (11,  1,  0, "02 課題読む",             "02 課題読む"),
            (11,  3,  0, "03 課題開始",             "03 課題開始"),
            (11,  7,  0, "04 課題終了一分前",       "04 課題終了一分前"),
            (11,  8,  0, "05 課題終了・移動開始",   "05 課題終了・移動開始"),

            (11, 10,  0, "01 移動開始",             "01 移動開始"),
            (11, 11,  0, "02 課題読む",             "02 課題読む"),
            (11, 13,  0, "03 課題開始",             "03 課題開始"),
            (11, 17,  0, "04 課題終了一分前",       "04 課題終了一分前"),
            (11, 18,  0, "05 課題終了・移動開始",   "05 課題終了・移動開始"),

            (11, 20,  0, "01 移動開始",             "01 移動開始"),
            (11, 21,  0, "02 課題読む",             "02 課題読む"),
            (11, 23,  0, "03 課題開始",             "03 課題開始"),
            (11, 27,  0, "04 課題終了一分前",       "04 課題終了一分前"),
            (11, 28,  0, "05 課題終了・移動開始",   "05 課題終了・移動開始"),

            (11, 30,  0, "01 移動開始",             "01 移動開始"),
            (11, 31,  0, "02 課題読む",             "02 課題読む"),
            (11, 33,  0, "03 課題開始",             "03 課題開始"),
            (11, 37,  0, "04 課題終了一分前",       "04 課題終了一分前"),
            (11, 38,  0, "05 課題終了・移動開始",   "05 課題終了・移動開始"),
            (11, 48, 15, "19 休憩に入る",           "19 休憩に入る"),

            (11, 58,  0, "17 開始2分前",            "17 開始2分前"),
            (11, 59,  0, "18 開始1分前",            "18 開始1分前"),

            (12,  0,  0, "01 移動開始",             "01 移動開始"),
            (12,  1,  0, "02 課題読む",             "02 課題読む"),
            (12,  3,  0, "03 課題開始",             "03 課題開始"),
            (12,  7,  0, "04 課題終了一分前",       "04 課題終了一分前"),
            (12,  8,  0, "05 課題終了・移動開始",   "05 課題終了・移動開始"),

            (12, 10,  0, "01 移動開始",             "01 移動開始"),
            (12, 11,  0, "02 課題読む",             "02 課題読む"),
            (12, 13,  0, "03 課題開始",             "03 課題開始"),
            (12, 17,  0, "04 課題終了一分前",       "04 課題終了一分前"),
            (12, 18,  0, "05 課題終了・移動開始",   "05 課題終了・移動開始"),

            (12, 20,  0, "01 移動開始",             "01 移動開始"),
            (12, 21,  0, "02 課題読む",             "02 課題読む"),
            (12, 23,  0, "03 課題開始",             "03 課題開始"),
            (12, 27,  0, "04 課題終了一分前",       "04 課題終了一分前"),
            (12, 28,  0, "05 課題終了・移動開始",   "05 課題終了・移動開始"),
            (12, 30,  0, "01 移動開始",             "01 移動開始"),

            (12, 31,  0, "02 課題読む",             "02 課題読む"),
            (12, 33,  0, "03 課題開始",             "03 課題開始"),
            (12, 37,  0, "04 課題終了一分前",       "04 課題終了一分前"),
            (12, 38,  0, "05 課題終了・移動開始",   "05 課題終了・移動開始"),
            (12, 48, 15, "19 休憩に入る",           "19 休憩に入る"),

            (13, 58,  0, "17 開始2分前",            "17 開始2分前"),
            (13, 59,  0, "18 開始1分前",            "18 開始1分前"),

            (14,  0,  0, "01 移動開始",             "01 移動開始"),
            (14,  1,  0, "02 課題読む",             "02 課題読む"),
            (14,  3,  0, "03 課題開始",             "03 課題開始"),
            (14,  7,  0, "04 課題終了一分前",       "04 課題終了一分前"),
            (14,  8,  0, "05 課題終了・移動開始",   "05 課題終了・移動開始"),

            (14, 10,  0, "01 移動開始",             "01 移動開始"),
            (14, 11,  0, "02 課題読む",             "02 課題読む"),
            (14, 13,  0, "03 課題開始",             "03 課題開始"),
            (14, 17,  0, "04 課題終了一分前",       "04 課題終了一分前"),
            (14, 18,  0, "05 課題終了・移動開始",   "05 課題終了・移動開始"),

            (14, 20,  0, "01 移動開始",             "01 移動開始"),
            (14, 21,  0, "02 課題読む",             "02 課題読む"),
            (14, 23,  0, "03 課題開始",             "03 課題開始"),
            (14, 27,  0, "04 課題終了一分前",       "04 課題終了一分前"),
            (14, 28,  0, "05 課題終了・移動開始",   "05 課題終了・移動開始"),

            (14, 30,  0, "01 移動開始",             "01 移動開始"),
            (14, 31,  0, "02 課題読む",             "02 課題読む"),
            (14, 33,  0, "03 課題開始",             "03 課題開始"),
            (14, 37,  0, "04 課題終了一分前",       "04 課題終了一分前"),
            (14, 38,  0, "05 課題終了・移動開始",   "05 課題終了・移動開始"),

            (14, 40,  0, "01 移動開始",             "01 移動開始"),
            (14, 41,  0, "02 課題読む",             "02 課題読む"),
            (14, 43,  0, "03 課題開始",             "03 課題開始"),
            (14, 47,  0, "04 課題終了一分前",       "04 課題終了一分前"),
            (14, 48,  0, "05 課題終了・移動開始",   "05 課題終了・移動開始"),

            (14, 50,  0, "01 移動開始",             "01 移動開始"),
            (14, 51,  0, "02 課題読む",             "02 課題読む"),
            (14, 53,  0, "03 課題開始",             "03 課題開始"),
            (14, 57,  0, "04 課題終了一分前",       "04 課題終了一分前"),
            (14, 58,  0, "05 課題終了・移動開始",   "05 課題終了・移動開始"),

            (15,  0,  0, "01 移動開始",             "01 移動開始"),
            (15,  1,  0, "02 課題読む",             "02 課題読む"),
            (15,  3,  0, "03 課題開始",             "03 課題開始"),
            (15,  7,  0, "04 課題終了一分前",       "04 課題終了一分前"),
            (15,  8,  0, "05 課題終了・移動開始",   "05 課題終了・移動開始"),
            (15,  8, 15, "19 休憩に入る",           "19 休憩に入る"),

            (15, 18,  0, "17 開始2分前",            "17 開始2分前"),
            (15, 19,  0, "18 開始1分前",            "18 開始1分前"),

            (15, 20,  0, "01 移動開始",             "01 移動開始"),
            (15, 21,  0, "02 課題読む",             "02 課題読む"),
            (15, 23,  0, "03 課題開始",             "03 課題開始"),
            (15, 27,  0, "04 課題終了一分前",       "04 課題終了一分前"),
            (15, 28,  0, "05 課題終了・移動開始",   "05 課題終了・移動開始"),

            (15, 30,  0, "01 移動開始",             "01 移動開始"),
            (15, 31,  0, "02 課題読む",             "02 課題読む"),
            (15, 33,  0, "03 課題開始",             "03 課題開始"),
            (15, 37,  0, "04 課題終了一分前",       "04 課題終了一分前"),
            (15, 38,  0, "05 課題終了・移動開始",   "05 課題終了・移動開始"),

            (15, 40,  0, "01 移動開始",             "01 移動開始"),
            (15, 41,  0, "02 課題読む",             "02 課題読む"),
            (15, 43,  0, "03 課題開始",             "03 課題開始"),
            (15, 47,  0, "04 課題終了一分前",       "04 課題終了一分前"),
            (15, 48,  0, "05 課題終了・移動開始",   "05 課題終了・移動開始"),

            (15, 50,  0, "01 移動開始",             "01 移動開始"),
            (15, 51,  0, "02 課題読む",             "02 課題読む"),
            (15, 53,  0, "03 課題開始",             "03 課題開始"),
            (15, 57,  0, "04 課題終了一分前",       "04 課題終了一分前"),
            (15, 58,  0, "05 課題終了・移動開始",   "05 課題終了・移動開始"),

            (16,  0,  0, "01 移動開始",             "01 移動開始"),
            (16,  1,  0, "02 課題読む",             "02 課題読む"),
            (16,  3,  0, "03 課題開始",             "03 課題開始"),
            (16,  7,  0, "04 課題終了一分前",       "04 課題終了一分前"),
            (16,  8,  0, "05 課題終了・移動開始",   "05 課題終了・移動開始"),

            (16, 10,  0, "01 移動開始",             "01 移動開始"),
            (16, 11,  0, "02 課題読む",             "02 課題読む"),
            (16, 13,  0, "03 課題開始",             "03 課題開始"),
            (16, 17,  0, "04 課題終了一分前",       "04 課題終了一分前"),
            (16, 18,  0, "05 課題終了・移動開始",   "05 課題終了・移動開始"),
            (16, 18, 15, "19 休憩に入る",           "19 休憩に入る"),

            (16, 28,  0, "17 開始2分前",            "17 開始2分前"),
            (16, 29,  0, "18 開始1分前",            "18 開始1分前"),

            (16, 30,  0, "01 移動開始",             "01 移動開始"),
            (16, 31,  0, "02 課題読む",             "02 課題読む"),
            (16, 33,  0, "03 課題開始",             "03 課題開始"),
            (16, 37,  0, "04 課題終了一分前",       "04 課題終了一分前"),
            (16, 38,  0, "05 課題終了・移動開始",   "05 課題終了・移動開始"),

            (16, 40,  0, "01 移動開始",             "01 移動開始"),
            (16, 41,  0, "02 課題読む",             "02 課題読む"),
            (16, 43,  0, "03 課題開始",             "03 課題開始"),
            (16, 47,  0, "04 課題終了一分前",       "04 課題終了一分前"),
            (16, 48,  0, "05 課題終了・移動開始",   "05 課題終了・移動開始"),

            (16, 50,  0, "01 移動開始",             "01 移動開始"),
            (16, 51,  0, "02 課題読む",             "02 課題読む"),
            (16, 53,  0, "03 課題開始",             "03 課題開始"),
            (16, 57,  0, "04 課題終了一分前",       "04 課題終了一分前"),
            (16, 58,  0, "05 課題終了・移動開始",   "05 課題終了・移動開始"),

            (17,  0,  0, "01 移動開始",             "01 移動開始"),
            (17,  1,  0, "02 課題読む",             "02 課題読む"),
            (17,  3,  0, "03 課題開始",             "03 課題開始"),
            (17,  7,  0, "04 課題終了一分前",       "04 課題終了一分前"),
            (17,  8,  0, "05 課題終了・移動開始",   "05 課題終了・移動開始"),

            (17, 10,  0, "01 移動開始",             "01 移動開始"),
            (17, 11,  0, "02 課題読む",             "02 課題読む"),
            (17, 13,  0, "03 課題開始",             "03 課題開始"),
            (17, 17,  0, "04 課題終了一分前",       "04 課題終了一分前"),
            (17, 18,  0, "05 課題終了・移動開始",   "05 課題終了・移動開始"),
            (17, 18, 15, "20 放送終了のアナウンス", "20 放送終了のアナウンス")
        ]
        
        let items = rows.map { (h, m, s, disp, res) in
            ScheduleItem(date: makeTime(h, m, s), displayName: disp, resourceName: res)
        }
        return items.sorted { $0.date < $1.date }
    }
    
    // デモ3: 時刻＋ファイル名テーブル
    private func demoSchedule3() -> [ScheduleItem] {
        let calendar = Calendar.current
        let now = Date()
        let comps = calendar.dateComponents([.year, .month, .day], from: now)
        func makeTime(_ h: Int, _ m: Int, _ s: Int = 0) -> Date {
            var c = comps
            c.hour = h
            c.minute = m
            c.second = s
            return calendar.date(from: c) ?? now
        }

        let rows: [(Int, Int, Int, String, String)] = [
            (7, 30,  0, "01 移動開始",             "01 移動開始"),
            (7, 30, 30, "02 課題読む",             "02 課題読む"),
            (7, 31,  0, "03 課題開始",             "03 課題開始"),
            (7, 31, 30, "04 課題終了一分前",       "04 課題終了一分前"),
            (7, 32,  0, "05 課題終了・移動開始",   "05 課題終了・移動開始"),
            (7, 32, 30, "06 課題終了",             "06 課題終了"),

            (7, 40,  0, "01 移動開始",             "01 移動開始"),
            (7, 40, 30, "02 課題読む",             "02 課題読む"),
            (7, 41,  0, "03 課題開始",             "03 課題開始"),
            (7, 41, 30, "04 課題終了一分前",       "04 課題終了一分前"),
            (7, 42,  0, "05 課題終了・移動開始",   "05 課題終了・移動開始"),
            (7, 42, 30, "06 課題終了",             "06 課題終了"),

            (7, 50,  0, "01 移動開始",             "01 移動開始"),
            (7, 50, 30, "02 課題読む",             "02 課題読む"),
            (7, 51,  0, "03 課題開始",             "03 課題開始"),
            (7, 51, 30, "04 課題終了一分前",       "04 課題終了一分前"),
            (7, 52,  0, "05 課題終了・移動開始",   "05 課題終了・移動開始"),
            (7, 52, 30, "06 課題終了",             "06 課題終了"),

            (8,  0,  0, "01 移動開始",             "01 移動開始"),
            (8,  0, 30, "02 課題読む",             "02 課題読む"),
            (8,  1,  0, "03 課題開始",             "03 課題開始"),
            (8,  1, 30, "04 課題終了一分前",       "04 課題終了一分前"),
            (8,  2,  0, "05 課題終了・移動開始",   "05 課題終了・移動開始"),
            (8,  2, 30, "06 課題終了",             "06 課題終了"),

            (8, 20,  0, "01 移動開始",             "01 移動開始"),
            (8, 20, 30, "02 課題読む",             "02 課題読む"),
            (8, 21,  0, "03 課題開始",             "03 課題開始"),
            (8, 21, 30, "04 課題終了一分前",       "04 課題終了一分前"),
            (8, 22,  0, "05 課題終了・移動開始",   "05 課題終了・移動開始"),
            (8, 22, 30, "06 課題終了",             "06 課題終了"),

            (9,  9,  0, "26 テストラン開始1分前",  "26 テストラン開始1分前"),
            (9, 10,  0, "01 移動開始",             "01 移動開始"),
            (9, 12,  0, "02 課題読む",             "02 課題読む"),
            (9, 13,  0, "03 課題開始",             "03 課題開始"),
            (9, 17,  0, "04 課題終了一分前",       "04 課題終了一分前"),
            (9, 18,  0, "06 課題終了",             "06 課題終了"),

            (9, 28,  0, "17 開始2分前",            "17 開始2分前"),
            (9, 29,  0, "18 開始1分前",            "18 開始1分前"),
            (9, 30,  0, "01 移動開始",             "01 移動開始"),
            (9, 32,  0, "02 課題読む",             "02 課題読む"),
            (9, 33,  0, "03 課題開始",             "03 課題開始"),
            (9, 37,  0, "04 課題終了一分前",       "04 課題終了一分前"),
            (9, 38,  0, "05 課題終了・移動開始",   "05 課題終了・移動開始"),

            (9, 40,  0, "01 移動開始",             "01 移動開始"),
            (9, 42,  0, "02 課題読む",             "02 課題読む"),
            (9, 43,  0, "03 課題開始",             "03 課題開始"),
            (9, 47,  0, "04 課題終了一分前",       "04 課題終了一分前"),
            (9, 48,  0, "05 課題終了・移動開始",   "05 課題終了・移動開始"),

            (9, 50,  0, "01 移動開始",             "01 移動開始"),
            (9, 52,  0, "02 課題読む",             "02 課題読む"),
            (9, 53,  0, "03 課題開始",             "03 課題開始"),
            (9, 57,  0, "04 課題終了一分前",       "04 課題終了一分前"),
            (9, 58,  0, "05 課題終了・移動開始",   "05 課題終了・移動開始"),

            (10,  0,  0, "01 移動開始",            "01 移動開始"),
            (10,  2,  0, "02 課題読む",            "02 課題読む"),
            (10,  3,  0, "03 課題開始",            "03 課題開始"),
            (10,  7,  0, "04 課題終了一分前",      "04 課題終了一分前"),
            (10,  8,  0, "05 課題終了・移動開始",  "05 課題終了・移動開始"),

            (10, 10,  0, "01 移動開始",            "01 移動開始"),
            (10, 12,  0, "02 課題読む",            "02 課題読む"),
            (10, 13,  0, "03 課題開始",            "03 課題開始"),
            (10, 17,  0, "04 課題終了一分前",      "04 課題終了一分前"),
            (10, 18,  0, "05 課題終了・移動開始",  "05 課題終了・移動開始"),

            (10, 20,  0, "01 移動開始",            "01 移動開始"),
            (10, 22,  0, "02 課題読む",            "02 課題読む"),
            (10, 23,  0, "03 課題開始",            "03 課題開始"),
            (10, 27,  0, "04 課題終了一分前",      "04 課題終了一分前"),
            (10, 28,  0, "05 課題終了・移動開始",  "05 課題終了・移動開始"),

            (10, 30,  0, "01 移動開始",            "01 移動開始"),
            (10, 32,  0, "02 課題読む",            "02 課題読む"),
            (10, 33,  0, "03 課題開始",            "03 課題開始"),
            (10, 37,  0, "04 課題終了一分前",      "04 課題終了一分前"),
            (10, 38,  0, "05 課題終了・移動開始",  "05 課題終了・移動開始"),
            (10, 38, 15, "19 休憩に入る",          "19 休憩に入る"),

            (10, 48,  0, "17 開始2分前",           "17 開始2分前"),
            (10, 49,  0, "18 開始1分前",           "18 開始1分前"),
            (10, 50,  0, "01 移動開始",            "01 移動開始"),
            (10, 52,  0, "02 課題読む",            "02 課題読む"),
            (10, 53,  0, "03 課題開始",            "03 課題開始"),
            (10, 57,  0, "04 課題終了一分前",      "04 課題終了一分前"),
            (10, 58,  0, "05 課題終了・移動開始",  "05 課題終了・移動開始"),

            (11,  0,  0, "01 移動開始",            "01 移動開始"),
            (11,  2,  0, "02 課題読む",            "02 課題読む"),
            (11,  3,  0, "03 課題開始",            "03 課題開始"),
            (11,  7,  0, "04 課題終了一分前",      "04 課題終了一分前"),
            (11,  8,  0, "05 課題終了・移動開始",  "05 課題終了・移動開始"),

            (11, 10,  0, "01 移動開始",            "01 移動開始"),
            (11, 12,  0, "02 課題読む",            "02 課題読む"),
            (11, 13,  0, "03 課題開始",            "03 課題開始"),
            (11, 17,  0, "04 課題終了一分前",      "04 課題終了一分前"),
            (11, 18,  0, "05 課題終了・移動開始",  "05 課題終了・移動開始"),

            (11, 20,  0, "01 移動開始",            "01 移動開始"),
            (11, 22,  0, "02 課題読む",            "02 課題読む"),
            (11, 23,  0, "03 課題開始",            "03 課題開始"),
            (11, 27,  0, "04 課題終了一分前",      "04 課題終了一分前"),
            (11, 28,  0, "05 課題終了・移動開始",  "05 課題終了・移動開始"),

            (11, 30,  0, "01 移動開始",            "01 移動開始"),
            (11, 32,  0, "02 課題読む",            "02 課題読む"),
            (11, 33,  0, "03 課題開始",            "03 課題開始"),
            (11, 37,  0, "04 課題終了一分前",      "04 課題終了一分前"),
            (11, 38,  0, "05 課題終了・移動開始",  "05 課題終了・移動開始"),

            (11, 40,  0, "01 移動開始",            "01 移動開始"),
            (11, 42,  0, "02 課題読む",            "02 課題読む"),
            (11, 43,  0, "03 課題開始",            "03 課題開始"),
            (11, 47,  0, "04 課題終了一分前",      "04 課題終了一分前"),
            (11, 48,  0, "05 課題終了・移動開始",  "05 課題終了・移動開始"),
            (11, 48, 15, "19 休憩に入る",          "19 休憩に入る"),

            (11, 58,  0, "17 開始2分前",           "17 開始2分前"),
            (11, 59,  0, "18 開始1分前",           "18 開始1分前"),

            (12,  0,  0, "01 移動開始",            "01 移動開始"),
            (12,  2,  0, "02 課題読む",            "02 課題読む"),
            (12,  3,  0, "03 課題開始",            "03 課題開始"),
            (12,  7,  0, "04 課題終了一分前",      "04 課題終了一分前"),
            (12,  8,  0, "05 課題終了・移動開始",  "05 課題終了・移動開始"),

            (12, 10,  0, "01 移動開始",            "01 移動開始"),
            (12, 12,  0, "02 課題読む",            "02 課題読む"),
            (12, 13,  0, "03 課題開始",            "03 課題開始"),
            (12, 17,  0, "04 課題終了一分前",      "04 課題終了一分前"),
            (12, 18,  0, "05 課題終了・移動開始",  "05 課題終了・移動開始"),

            (12, 20,  0, "01 移動開始",            "01 移動開始"),
            (12, 22,  0, "02 課題読む",            "02 課題読む"),
            (12, 23,  0, "03 課題開始",            "03 課題開始"),
            (12, 27,  0, "04 課題終了一分前",      "04 課題終了一分前"),
            (12, 28,  0, "05 課題終了・移動開始",  "05 課題終了・移動開始"),

            (12, 30,  0, "01 移動開始",            "01 移動開始"),
            (12, 32,  0, "02 課題読む",            "02 課題読む"),
            (12, 33,  0, "03 課題開始",            "03 課題開始"),
            (12, 37,  0, "04 課題終了一分前",      "04 課題終了一分前"),
            (12, 38,  0, "05 課題終了・移動開始",  "05 課題終了・移動開始"),

            (12, 40,  0, "01 移動開始",            "01 移動開始"),
            (12, 42,  0, "02 課題読む",            "02 課題読む"),
            (12, 43,  0, "03 課題開始",            "03 課題開始"),
            (12, 47,  0, "04 課題終了一分前",      "04 課題終了一分前"),
            (12, 48,  0, "05 課題終了・移動開始",  "05 課題終了・移動開始"),
            (12, 48, 15, "19 休憩に入る",          "19 休憩に入る"),

            (13, 58,  0, "17 開始2分前",           "17 開始2分前"),
            (13, 59,  0, "18 開始1分前",           "18 開始1分前"),

            (14,  0,  0, "01 移動開始",            "01 移動開始"),
            (14,  2,  0, "02 課題読む",            "02 課題読む"),
            (14,  3,  0, "03 課題開始",            "03 課題開始"),
            (14,  7,  0, "04 課題終了一分前",      "04 課題終了一分前"),
            (14,  8,  0, "05 課題終了・移動開始",  "05 課題終了・移動開始"),

            (14, 10,  0, "01 移動開始",            "01 移動開始"),
            (14, 12,  0, "02 課題読む",            "02 課題読む"),
            (14, 13,  0, "03 課題開始",            "03 課題開始"),
            (14, 17,  0, "04 課題終了一分前",      "04 課題終了一分前"),
            (14, 18,  0, "05 課題終了・移動開始",  "05 課題終了・移動開始"),

            (14, 20,  0, "01 移動開始",            "01 移動開始"),
            (14, 22,  0, "02 課題読む",            "02 課題読む"),
            (14, 23,  0, "03 課題開始",            "03 課題開始"),
            (14, 27,  0, "04 課題終了一分前",      "04 課題終了一分前"),
            (14, 28,  0, "05 課題終了・移動開始",  "05 課題終了・移動開始"),

            (14, 30,  0, "01 移動開始",            "01 移動開始"),
            (14, 32,  0, "02 課題読む",            "02 課題読む"),
            (14, 33,  0, "03 課題開始",            "03 課題開始"),
            (14, 37,  0, "04 課題終了一分前",      "04 課題終了一分前"),
            (14, 38,  0, "05 課題終了・移動開始",  "05 課題終了・移動開始"),

            (14, 40,  0, "01 移動開始",            "01 移動開始"),
            (14, 42,  0, "02 課題読む",            "02 課題読む"),
            (14, 43,  0, "03 課題開始",            "03 課題開始"),
            (14, 47,  0, "04 課題終了一分前",      "04 課題終了一分前"),
            (14, 48,  0, "05 課題終了・移動開始",  "05 課題終了・移動開始"),

            (14, 50,  0, "01 移動開始",            "01 移動開始"),
            (14, 52,  0, "02 課題読む",            "02 課題読む"),
            (14, 53,  0, "03 課題開始",            "03 課題開始"),
            (14, 57,  0, "04 課題終了一分前",      "04 課題終了一分前"),
            (14, 58,  0, "05 課題終了・移動開始",  "05 課題終了・移動開始"),

            (15,  0,  0, "01 移動開始",            "01 移動開始"),
            (15,  2,  0, "02 課題読む",            "02 課題読む"),
            (15,  3,  0, "03 課題開始",            "03 課題開始"),
            (15,  7,  0, "04 課題終了一分前",      "04 課題終了一分前"),
            (15,  8,  0, "05 課題終了・移動開始",  "05 課題終了・移動開始"),
            (15,  8, 15, "19 休憩に入る",          "19 休憩に入る"),

            (15, 18,  0, "17 開始2分前",           "17 開始2分前"),
            (15, 19,  0, "18 開始1分前",           "18 開始1分前"),

            (15, 20,  0, "01 移動開始",            "01 移動開始"),
            (15, 22,  0, "02 課題読む",            "02 課題読む"),
            (15, 23,  0, "03 課題開始",            "03 課題開始"),
            (15, 27,  0, "04 課題終了一分前",      "04 課題終了一分前"),
            (15, 28,  0, "05 課題終了・移動開始",  "05 課題終了・移動開始"),

            (15, 30,  0, "01 移動開始",            "01 移動開始"),
            (15, 32,  0, "02 課題読む",            "02 課題読む"),
            (15, 33,  0, "03 課題開始",            "03 課題開始"),
            (15, 37,  0, "04 課題終了一分前",      "04 課題終了一分前"),
            (15, 38,  0, "05 課題終了・移動開始",  "05 課題終了・移動開始"),

            (15, 40,  0, "01 移動開始",            "01 移動開始"),
            (15, 42,  0, "02 課題読む",            "02 課題読む"),
            (15, 43,  0, "03 課題開始",            "03 課題開始"),
            (15, 47,  0, "04 課題終了一分前",      "04 課題終了一分前"),
            (15, 48,  0, "05 課題終了・移動開始",  "05 課題終了・移動開始"),

            (15, 50,  0, "01 移動開始",            "01 移動開始"),
            (15, 52,  0, "02 課題読む",            "02 課題読む"),
            (15, 53,  0, "03 課題開始",            "03 課題開始"),
            (15, 57,  0, "04 課題終了一分前",      "04 課題終了一分前"),
            (15, 58,  0, "05 課題終了・移動開始",  "05 課題終了・移動開始"),

            (16,  0,  0, "01 移動開始",            "01 移動開始"),
            (16,  2,  0, "02 課題読む",            "02 課題読む"),
            (16,  3,  0, "03 課題開始",            "03 課題開始"),
            (16,  7,  0, "04 課題終了一分前",      "04 課題終了一分前"),
            (16,  8,  0, "05 課題終了・移動開始",  "05 課題終了・移動開始"),

            (16, 10,  0, "01 移動開始",            "01 移動開始"),
            (16, 12,  0, "02 課題読む",            "02 課題読む"),
            (16, 13,  0, "03 課題開始",            "03 課題開始"),
            (16, 17,  0, "04 課題終了一分前",      "04 課題終了一分前"),
            (16, 18,  0, "05 課題終了・移動開始",  "05 課題終了・移動開始"),
            (16, 18, 15, "19 休憩に入る",          "19 休憩に入る"),

            (16, 28,  0, "17 開始2分前",           "17 開始2分前"),
            (16, 29,  0, "18 開始1分前",           "18 開始1分前"),

            (16, 30,  0, "01 移動開始",            "01 移動開始"),
            (16, 32,  0, "02 課題読む",            "02 課題読む"),
            (16, 33,  0, "03 課題開始",            "03 課題開始"),
            (16, 37,  0, "04 課題終了一分前",      "04 課題終了一分前"),
            (16, 38,  0, "05 課題終了・移動開始",  "05 課題終了・移動開始"),

            (16, 40,  0, "01 移動開始",            "01 移動開始"),
            (16, 42,  0, "02 課題読む",            "02 課題読む"),
            (16, 43,  0, "03 課題開始",            "03 課題開始"),
            (16, 47,  0, "04 課題終了一分前",      "04 課題終了一分前"),
            (16, 48,  0, "05 課題終了・移動開始",  "05 課題終了・移動開始"),

            (16, 50,  0, "01 移動開始",            "01 移動開始"),
            (16, 52,  0, "02 課題読む",            "02 課題読む"),
            (16, 53,  0, "03 課題開始",            "03 課題開始"),
            (16, 57,  0, "04 課題終了一分前",      "04 課題終了一分前"),
            (16, 58,  0, "05 課題終了・移動開始",  "05 課題終了・移動開始"),

            (17,  0,  0, "01 移動開始",            "01 移動開始"),
            (17,  2,  0, "02 課題読む",            "02 課題読む"),
            (17,  3,  0, "03 課題開始",            "03 課題開始"),
            (17,  7,  0, "04 課題終了一分前",      "04 課題終了一分前"),
            (17,  8,  0, "05 課題終了・移動開始",  "05 課題終了・移動開始"),

            (17, 10,  0, "01 移動開始",            "01 移動開始"),
            (17, 12,  0, "02 課題読む",            "02 課題読む"),
            (17, 13,  0, "03 課題開始",            "03 課題開始"),
            (17, 17,  0, "04 課題終了一分前",      "04 課題終了一分前"),
            (17, 18,  0, "05 課題終了・移動開始",  "05 課題終了・移動開始"),
            (17, 18, 15, "20 放送終了のアナウンス", "20 放送終了のアナウンス")
        ]

        let items = rows.map { (h, m, s, disp, res) in
            ScheduleItem(date: makeTime(h, m, s), displayName: disp, resourceName: res)
        }
        return items.sorted { $0.date < $1.date }
    }
    
    private func playAudio(_ item: ScheduleItem) {
        print("🔊 スケジュール再生: \(item.displayName)")
        audioManager.play(resourceName: item.resourceName, isMuted: isMuted)
        nextDisplayName = item.displayName
    }
}

